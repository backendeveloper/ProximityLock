name: Release

on:
  push:
    tags: ["v*"]

permissions:
  contents: write

jobs:
  release:
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4

      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode_16.app/Contents/Developer

      - name: Build & Test
        run: |
          swift build
          swift test

      - name: Build Release Binary
        run: swift build -c release

      - name: Create App Bundle
        run: |
          mkdir -p ProximityLock.app/Contents/MacOS
          cp .build/release/ProximityLock ProximityLock.app/Contents/MacOS/
          cp Resources/Info.plist ProximityLock.app/Contents/

      - name: Archive
        run: |
          tar czf ProximityLock-${{ github.ref_name }}-arm64.tar.gz ProximityLock.app
          shasum -a 256 ProximityLock-${{ github.ref_name }}-arm64.tar.gz > ProximityLock-${{ github.ref_name }}-arm64.tar.gz.sha256

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create ${{ github.ref_name }} \
            --title "${{ github.ref_name }}" \
            --generate-notes \
            ProximityLock-${{ github.ref_name }}-arm64.tar.gz \
            ProximityLock-${{ github.ref_name }}-arm64.tar.gz.sha256

      - name: Update Homebrew Formula
        env:
          TAP_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
        run: |
          VERSION="${{ github.ref_name }}"
          TARBALL_URL="https://github.com/backendeveloper/ProximityLock/archive/refs/tags/${VERSION}.tar.gz"
          curl -sL "$TARBALL_URL" -o source.tar.gz
          SHA256=$(shasum -a 256 source.tar.gz | awk '{print $1}')
          REVISION=$(git rev-parse HEAD)

          cat > formula.rb << FORMULA
          class Proximitylock < Formula
            desc "Auto-lock macOS screen based on Apple Watch BLE proximity"
            homepage "https://github.com/backendeveloper/ProximityLock"
            url "${TARBALL_URL}"
            sha256 "${SHA256}"
            license "MIT"
            version "${VERSION#v}"

            head "https://github.com/backendeveloper/ProximityLock.git", branch: "main"

            depends_on xcode: ["15.0", :build]
            depends_on :macos => :sonoma

            def install
              system "swift", "build",
                     "--disable-sandbox",
                     "-c", "release"

              bin.install ".build/release/ProximityLock"

              app_bundle = prefix/"ProximityLock.app/Contents"
              (app_bundle/"MacOS").mkpath
              ln_s bin/"ProximityLock", app_bundle/"MacOS/ProximityLock"
              cp "Resources/Info.plist", app_bundle/"Info.plist"
            end

            def post_install
              mkdir_p "#{Dir.home}/.config/proximity-lock"
            end

            def caveats
              <<~EOS
                To start ProximityLock:
                  open #{opt_prefix}/ProximityLock.app

                Configuration:
                  ~/.config/proximity-lock/config.json

                Logs:
                  log stream --predicate 'subsystem == "com.proximity-lock"' --level debug
              EOS
            end
          end
          FORMULA

          # Remove leading whitespace from heredoc
          sed -i '' 's/^          //' formula.rb

          git clone https://x-access-token:${TAP_TOKEN}@github.com/backendeveloper/homebrew-tap.git tap
          cp formula.rb tap/Formula/proximitylock.rb
          cd tap
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Formula/proximitylock.rb
          git commit -m "Update proximitylock to ${VERSION}"
          git push
